# PLANO DE IMPLEMENTA√á√ÉO: SECRET√ÅRIA JUR√çDICA IA ENGINE

**Data:** 30/12/2024
**Vers√£o:** 1.0
**Status:** Planejamento
**Produto:** Garcez Palha Engine - Secret√°ria Jur√≠dica IA
**Modelo:** B2B2C White-Label

---

## üìã SUM√ÅRIO EXECUTIVO

Este documento detalha a implementa√ß√£o do **produto PRINCIPAL** da plataforma: uma **Secret√°ria Jur√≠dica IA** que trabalha 24/7 para advogados parceiros.

### O Produto

**Garcez Palha Engine** = Secret√°ria Jur√≠dica IA white-label que:

1. ‚úÖ **Captura leads** no site do advogado 24/7
2. ‚úÖ **Qualifica casos** juridicamente (103 perguntas especializadas)
3. ‚úÖ **Agenda consultas** automaticamente
4. ‚úÖ **Gera propostas** personalizadas com valores
5. ‚úÖ **Gerencia processos** e prazos
6. ‚úÖ **White-label completo** (logo, cores, dom√≠nio do parceiro)

### Diferencial Competitivo

| Feature | Garcez Palha Engine | Chatbot Gen√©rico | Ulio.ai |
|---------|---------------------|------------------|---------|
| Chat IA Especializado | ‚úÖ 9 √°reas jur√≠dicas | ‚ùå Gen√©rico | ‚ö†Ô∏è Telefone apenas |
| Qualifica√ß√£o Jur√≠dica | ‚úÖ 103 perguntas | ‚ùå B√°sico | ‚ùå N√£o tem |
| Agendamento | ‚úÖ Autom√°tico | ‚ö†Ô∏è Manual | ‚úÖ Autom√°tico |
| Proposta com Valores | ‚úÖ Sim | ‚ùå N√£o | ‚ùå N√£o |
| Gest√£o de Processos | ‚úÖ Completo | ‚ùå N√£o | ‚ùå N√£o |
| Documentos Legais | ‚úÖ 9 templates | ‚ùå N√£o | ‚ùå N√£o |
| White-Label | ‚úÖ Completo | ‚ö†Ô∏è Limitado | ‚úÖ Completo |
| **Pre√ßo** | **R$ 497/m√™s** | R$ 200-800/m√™s | R$ 1.500/m√™s |

**Posicionamento:** Mais completo que chatbots, mais barato que Ulio.ai, especializado em direito.

---

## üéØ ESTRUTURA DE PRODUTOS

### **PLANO STARTER** - R$ 497/m√™s (Secret√°ria Jur√≠dica IA)

**P√∫blico:** Advogados solo e escrit√≥rios pequenos (1-2 advogados)

**Inclui:**
- ‚úÖ Chat IA jur√≠dico 24/7 (9 √°reas do direito)
- ‚úÖ Qualifica√ß√£o autom√°tica de casos (103 perguntas)
- ‚úÖ Agendamento de consultas (Google Calendar integrado)
- ‚úÖ Gera√ß√£o de propostas personalizadas
- ‚úÖ Dashboard com m√©tricas em tempo real
- ‚úÖ White-label: logo + cores + subdom√≠nio
- ‚úÖ 100 conversas qualificadas/m√™s
- ‚úÖ 1 usu√°rio
- ‚úÖ Suporte via email
- ‚úÖ 30 dias gr√°tis

**Foco:** Captura e qualifica√ß√£o de leads

---

### **PLANO PRO** - R$ 997/m√™s (Secret√°ria + Marketing)

**P√∫blico:** Escrit√≥rios m√©dios (3-5 advogados) que querem crescer

**Tudo do Starter +**
- ‚úÖ **Marketing Automation:**
  - Cria√ß√£o de conte√∫do (Instagram, LinkedIn, Blog)
  - Calend√°rio de conte√∫do mensal
  - Otimiza√ß√£o de an√∫ncios Google Ads
  - An√°lise de performance
- ‚úÖ 500 conversas qualificadas/m√™s
- ‚úÖ 5 usu√°rios
- ‚úÖ Dom√≠nio customizado (.com.br pr√≥prio)
- ‚úÖ Integra√ß√£o WhatsApp Business
- ‚úÖ Notifica√ß√µes Telegram
- ‚úÖ Relat√≥rios semanais
- ‚úÖ Suporte priorit√°rio (WhatsApp)

**Foco:** Captura + qualifica√ß√£o + gera√ß√£o de demanda

---

### **PLANO ENTERPRISE** - R$ 1.997/m√™s (Customizado)

**P√∫blico:** Escrit√≥rios grandes (6+ advogados) ou redes

**Tudo do Pro +**
- ‚úÖ Conversas ilimitadas
- ‚úÖ Usu√°rios ilimitados
- ‚úÖ API para integra√ß√µes customizadas
- ‚úÖ White-label 100% (sem marca Garcez Palha)
- ‚úÖ Treinamento de IA com casos do escrit√≥rio
- ‚úÖ Customiza√ß√£o de workflows
- ‚úÖ Onboarding assistido (call + setup)
- ‚úÖ Suporte dedicado (WhatsApp + call mensal)
- ‚úÖ SLA de uptime 99.9%

**Foco:** Solu√ß√£o enterprise completa

---

## üèóÔ∏è ARQUITETURA DO PRODUTO

### Fluxo do Cliente Final (Pessoa com problema jur√≠dico)

```
1Ô∏è‚É£ DESCOBERTA
   ‚Üì
   Cliente pesquisa "advogado trabalhista s√£o paulo" no Google
   ‚Üì
   Clica no site do advogado parceiro (silva-advocacia.com.br)

2Ô∏è‚É£ CAPTURA
   ‚Üì
   Landing page com chat IA aparece
   "Ol√°! Sou a assistente do Dr. Silva. Como posso ajudar?"
   ‚Üì
   Cliente: "Fui demitido sem justa causa, tenho direito?"

3Ô∏è‚É£ QUALIFICA√á√ÉO
   ‚Üì
   Chat IA (Agente Trabalhista) faz 103 perguntas:
   - Tempo de empresa?
   - Tipo de demiss√£o?
   - Aviso pr√©vio pago?
   - FGTS sacado?
   - Valores recebidos?
   ‚Üì
   Sistema calcula:
   - Urg√™ncia: 8/10 (demiss√£o recente)
   - Probabilidade de ganho: 85%
   - Valor estimado causa: R$ 15.000
   - Score final: 82/100 (HOT LEAD)

4Ô∏è‚É£ AGENDAMENTO
   ‚Üì
   "Pelo que voc√™ me contou, o Dr. Silva pode te ajudar!"
   "Escolha um hor√°rio para consulta:"
   [Calend√°rio com hor√°rios dispon√≠veis]
   ‚Üì
   Cliente escolhe: Amanh√£ 14h
   ‚Üì
   Sistema envia:
   - Confirma√ß√£o por email
   - Lembrete WhatsApp (2h antes)
   - Adiciona no Google Calendar do advogado

5Ô∏è‚É£ PROPOSTA
   ‚Üì
   Ap√≥s consulta presencial/online:
   ‚Üì
   Advogado clica "Gerar Proposta"
   ‚Üì
   Sistema cria proposta autom√°tica:
   - An√°lise do caso
   - Chances de sucesso
   - Honor√°rios: R$ 3.000 (30% √™xito) ou R$ 5.000 (fixo)
   - Prazo estimado: 12-18 meses
   - Link de pagamento (Stripe)

6Ô∏è‚É£ CONVERS√ÉO
   ‚Üì
   Cliente aceita proposta
   ‚Üì
   Paga entrada via link
   ‚Üì
   Vira CLIENTE no sistema
   ‚Üì
   Processo acompanhado no dashboard
```

### Fluxo do Advogado Parceiro

```
1Ô∏è‚É£ ONBOARDING (60 segundos)
   ‚Üì
   Acessa: garcezpalha.com.br/parceiros
   ‚Üì
   Clica "Come√ßar Agora - 30 Dias Gr√°tis"
   ‚Üì
   Preenche:
   - Nome, Email, Telefone (10s)
   - Nome do escrit√≥rio (5s)
   - Escolhe subdom√≠nio: silva-advocacia (15s)
   - Escolhe cor principal (10s)
   - Upload logo (20s)
   ‚Üì
   Sistema cria:
   - Conta no Supabase Auth
   - Tenant no banco (RLS ativado)
   - Subdom√≠nio: silva-advocacia.garcezpalha.com.br
   - Landing page personalizada
   ‚Üì
   Redireciona para: Dashboard do parceiro

2Ô∏è‚É£ CONFIGURA√á√ÉO (5 minutos)
   ‚Üì
   Dashboard mostra:
   - "Bem-vindo, Dr. Silva!"
   - "Seu site: silva-advocacia.garcezpalha.com.br"
   - "Personalize sua mensagem de boas-vindas"
   ‚Üì
   Advogado edita:
   - Mensagem do chat: "Ol√°! Sou assistente do Dr. Silva..."
   - √Åreas de atua√ß√£o: [Trabalhista, Civil, Consumidor]
   - Hor√°rios de atendimento: Seg-Sex 9h-18h
   - Integra Google Calendar (OAuth)
   - Configura valores m√©dios por tipo de caso
   ‚Üì
   Sistema atualiza tenant config

3Ô∏è‚É£ DIVULGA√á√ÉO (cont√≠nuo)
   ‚Üì
   Advogado compartilha link:
   - Instagram bio
   - Facebook page
   - Google Meu Neg√≥cio
   - Email signature
   - An√∫ncios Google Ads (opcional)

4Ô∏è‚É£ ATENDIMENTO (di√°rio)
   ‚Üì
   Dashboard mostra:
   - 5 NOVOS LEADS (3 HOT, 1 WARM, 1 COLD)
   ‚Üì
   Advogado prioriza HOT leads:
   - Lead #1: Score 92 - Demiss√£o sem justa causa
     ‚Üí Consulta agendada: Hoje 15h
     ‚Üí Ligar agora para confirmar
   ‚Üì
   Ap√≥s consulta:
   - Clica "Gerar Proposta"
   - Sistema cria proposta
   - Envia para cliente
   - Acompanha convers√£o

5Ô∏è‚É£ GEST√ÉO (semanal)
   ‚Üì
   Dashboard mostra:
   - 42 conversas neste m√™s
   - 18 leads qualificados (HOT: 8, WARM: 6, COLD: 4)
   - 5 consultas agendadas
   - 3 propostas enviadas
   - 2 clientes novos (convers√£o 40%)
   - Receita gerada: R$ 12.000
   ‚Üì
   ROI: Paga R$ 497, fatura R$ 12.000 = 24x
```

---

## üóÑÔ∏è SCHEMA DE BANCO DE DADOS

### Tabelas J√° Existentes (N√£o Mexer)

```sql
-- Sistema jur√≠dico completo j√° funciona
‚úÖ leads (com tenant_id)
‚úÖ clientes (com tenant_id)
‚úÖ processos (com tenant_id)
‚úÖ agendamentos (com tenant_id)
‚úÖ propostas (com tenant_id)
‚úÖ chat_messages (com tenant_id)
‚úÖ documentos (com tenant_id)
‚úÖ perguntas_qualificacao (103 perguntas por √°rea)
```

### Novas Tabelas Necess√°rias

```sql
-- =============================================================================
-- PLANOS E ASSINATURAS
-- =============================================================================

CREATE TABLE plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL, -- 'starter', 'pro', 'enterprise'
  display_name TEXT NOT NULL, -- 'Plano Starter', 'Plano Pro', etc
  description TEXT NOT NULL,
  price_monthly DECIMAL(10, 2) NOT NULL, -- 497.00, 997.00, 1997.00

  -- Limites do plano
  max_conversations_per_month INTEGER NOT NULL, -- 100, 500, -1 (ilimitado)
  max_users INTEGER NOT NULL, -- 1, 5, -1 (ilimitado)

  -- Features
  features JSONB NOT NULL DEFAULT '{
    "chat_ai": true,
    "qualification": true,
    "scheduling": true,
    "proposals": true,
    "whitelabel_subdomain": true,
    "whitelabel_domain": false,
    "marketing_automation": false,
    "whatsapp_integration": false,
    "telegram_notifications": false,
    "api_access": false,
    "priority_support": false,
    "custom_training": false
  }',

  -- Status
  active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Seed plans
INSERT INTO plans (name, display_name, description, price_monthly, max_conversations_per_month, max_users, features) VALUES
(
  'starter',
  'Plano Starter',
  'Secret√°ria Jur√≠dica IA completa para advogados solo',
  497.00,
  100,
  1,
  '{
    "chat_ai": true,
    "qualification": true,
    "scheduling": true,
    "proposals": true,
    "whitelabel_subdomain": true,
    "whitelabel_domain": false,
    "marketing_automation": false,
    "whatsapp_integration": false,
    "telegram_notifications": false,
    "api_access": false,
    "priority_support": false,
    "custom_training": false
  }'
),
(
  'pro',
  'Plano Pro',
  'Secret√°ria + Marketing Automation para crescer',
  997.00,
  500,
  5,
  '{
    "chat_ai": true,
    "qualification": true,
    "scheduling": true,
    "proposals": true,
    "whitelabel_subdomain": true,
    "whitelabel_domain": true,
    "marketing_automation": true,
    "whatsapp_integration": true,
    "telegram_notifications": true,
    "api_access": false,
    "priority_support": true,
    "custom_training": false
  }'
),
(
  'enterprise',
  'Plano Enterprise',
  'Solu√ß√£o enterprise completa e customizada',
  1997.00,
  -1,
  -1,
  '{
    "chat_ai": true,
    "qualification": true,
    "scheduling": true,
    "proposals": true,
    "whitelabel_subdomain": true,
    "whitelabel_domain": true,
    "marketing_automation": true,
    "whatsapp_integration": true,
    "telegram_notifications": true,
    "api_access": true,
    "priority_support": true,
    "custom_training": true
  }'
);

-- =============================================================================
-- ATUALIZAR TABELA TENANTS
-- =============================================================================

ALTER TABLE tenants ADD COLUMN plan_id UUID REFERENCES plans(id);
ALTER TABLE tenants ADD COLUMN plan_name TEXT DEFAULT 'starter';

-- Adicionar colunas de uso mensal
ALTER TABLE tenants ADD COLUMN current_month_conversations INTEGER DEFAULT 0;
ALTER TABLE tenants ADD COLUMN current_month_starts_at DATE DEFAULT CURRENT_DATE;

-- Fun√ß√£o para resetar contadores mensais
CREATE OR REPLACE FUNCTION reset_monthly_usage()
RETURNS void AS $$
BEGIN
  UPDATE tenants
  SET
    current_month_conversations = 0,
    current_month_starts_at = CURRENT_DATE
  WHERE current_month_starts_at < DATE_TRUNC('month', CURRENT_DATE);
END;
$$ LANGUAGE plpgsql;

-- =============================================================================
-- TRACKING DE CONVERSAS
-- =============================================================================

CREATE TABLE conversation_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,

  -- Dados do visitante
  visitor_id TEXT NOT NULL, -- UUID gerado no frontend
  visitor_name TEXT,
  visitor_email TEXT,
  visitor_phone TEXT,

  -- Conversa
  area_juridica TEXT, -- 'trabalhista', 'civil', etc
  messages_count INTEGER DEFAULT 0,
  qualification_completed BOOLEAN DEFAULT false,
  qualification_score INTEGER, -- 0-100
  qualification_tier TEXT, -- 'hot', 'warm', 'cold'

  -- Resultado
  lead_created BOOLEAN DEFAULT false,
  lead_id UUID REFERENCES leads(id),
  appointment_scheduled BOOLEAN DEFAULT false,
  appointment_id UUID REFERENCES agendamentos(id),

  -- Timestamps
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_message_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  duration INTEGER, -- Segundos

  -- Metadata
  source TEXT, -- 'website', 'whatsapp', 'facebook'
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,

  CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
);

CREATE INDEX idx_conversation_sessions_tenant_id ON conversation_sessions(tenant_id);
CREATE INDEX idx_conversation_sessions_started_at ON conversation_sessions(started_at DESC);
CREATE INDEX idx_conversation_sessions_lead_id ON conversation_sessions(lead_id);

-- Trigger para incrementar contador de conversas do tenant
CREATE OR REPLACE FUNCTION increment_tenant_conversations()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.qualification_completed = true AND OLD.qualification_completed = false THEN
    UPDATE tenants
    SET current_month_conversations = current_month_conversations + 1
    WHERE id = NEW.tenant_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_increment_conversations
AFTER UPDATE ON conversation_sessions
FOR EACH ROW
EXECUTE FUNCTION increment_tenant_conversations();

-- =============================================================================
-- RLS POLICIES
-- =============================================================================

ALTER TABLE plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE conversation_sessions ENABLE ROW LEVEL SECURITY;

-- Todos podem ver planos
CREATE POLICY "Plans are publicly readable"
ON plans FOR SELECT
USING (true);

-- Tenant s√≥ v√™ suas pr√≥prias conversas
CREATE POLICY "Users can view their tenant conversations"
ON conversation_sessions FOR SELECT
USING (
  tenant_id IN (
    SELECT tenant_id FROM tenant_members
    WHERE user_id = auth.uid() AND status = 'active'
  )
);

CREATE POLICY "System can manage conversations"
ON conversation_sessions FOR ALL
USING (true); -- Controlado via service role
```

---

## üîß IMPLEMENTA√á√ÉO PASSO A PASSO

### FASE 1: Chat Widget Embeddable (3 dias)

**Objetivo:** Widget de chat que advogado pode colocar no site dele

#### 1.1 Create Chat Widget Component

**Arquivo:** `src/components/tenant/ChatWidget.tsx`

```typescript
'use client'

import { useState, useEffect, useRef } from 'react'
import { useTenantBranding } from './TenantBrandingProvider'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { MessageCircle, X, Send } from 'lucide-react'

interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
}

interface ChatWidgetProps {
  tenantId: string
  sessionId?: string
}

export function ChatWidget({ tenantId, sessionId: initialSessionId }: ChatWidgetProps) {
  const branding = useTenantBranding()
  const [isOpen, setIsOpen] = useState(false)
  const [messages, setMessages] = useState<Message[]>([])
  const [input, setInput] = useState('')
  const [loading, setLoading] = useState(false)
  const [sessionId, setSessionId] = useState(initialSessionId || '')
  const messagesEndRef = useRef<HTMLDivElement>(null)

  // Inicializar sess√£o
  useEffect(() => {
    if (!sessionId) {
      const newSessionId = `visitor_${Date.now()}_${Math.random().toString(36).slice(2)}`
      setSessionId(newSessionId)
      localStorage.setItem('chat_session_id', newSessionId)
    }
  }, [sessionId])

  // Mensagem inicial
  useEffect(() => {
    if (isOpen && messages.length === 0) {
      setMessages([
        {
          id: '1',
          role: 'assistant',
          content: branding.welcome_message || 'Ol√°! Como posso ajudar com sua quest√£o jur√≠dica?',
          timestamp: new Date(),
        },
      ])
    }
  }, [isOpen, messages.length, branding.welcome_message])

  // Auto-scroll
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  const sendMessage = async () => {
    if (!input.trim() || loading) return

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: input,
      timestamp: new Date(),
    }

    setMessages((prev) => [...prev, userMessage])
    setInput('')
    setLoading(true)

    try {
      const res = await fetch('/api/chat/message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tenantId,
          sessionId,
          message: input,
          messages: messages.map((m) => ({ role: m.role, content: m.content })),
        }),
      })

      const data = await res.json()

      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: data.response,
        timestamp: new Date(),
      }

      setMessages((prev) => [...prev, assistantMessage])

      // Se completou qualifica√ß√£o, mostrar score
      if (data.qualificationCompleted) {
        const scoreMessage: Message = {
          id: (Date.now() + 2).toString(),
          role: 'assistant',
          content: `‚úÖ Qualifica√ß√£o conclu√≠da!\n\nScore: ${data.score}/100 (${data.tier.toUpperCase()})\n\nUm de nossos advogados entrar√° em contato em breve. Gostaria de agendar uma consulta agora?`,
          timestamp: new Date(),
        }
        setMessages((prev) => [...prev, scoreMessage])
      }
    } catch (error) {
      console.error('Error sending message:', error)
    } finally {
      setLoading(false)
    }
  }

  return (
    <>
      {/* Bot√£o flutuante */}
      {!isOpen && (
        <button
          onClick={() => setIsOpen(true)}
          className="fixed bottom-6 right-6 w-16 h-16 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 z-50"
          style={{ backgroundColor: branding.primary_color }}
        >
          <MessageCircle className="w-8 h-8 text-white" />
        </button>
      )}

      {/* Chat window */}
      {isOpen && (
        <div
          className="fixed bottom-6 right-6 w-96 h-[600px] bg-white rounded-lg shadow-2xl flex flex-col z-50"
          style={{ borderTop: `4px solid ${branding.primary_color}` }}
        >
          {/* Header */}
          <div
            className="p-4 text-white rounded-t-lg flex items-center justify-between"
            style={{ backgroundColor: branding.primary_color }}
          >
            <div className="flex items-center gap-3">
              {branding.logo_url ? (
                <img src={branding.logo_url} alt={branding.name} className="h-8" />
              ) : (
                <MessageCircle className="w-6 h-6" />
              )}
              <div>
                <h3 className="font-semibold">{branding.name}</h3>
                <p className="text-xs opacity-90">Online agora</p>
              </div>
            </div>
            <button onClick={() => setIsOpen(false)}>
              <X className="w-5 h-5" />
            </button>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[80%] rounded-lg p-3 ${
                    message.role === 'user'
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-100 text-gray-900'
                  }`}
                  style={
                    message.role === 'user'
                      ? { backgroundColor: branding.primary_color }
                      : {}
                  }
                >
                  <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                  <p className="text-xs opacity-70 mt-1">
                    {message.timestamp.toLocaleTimeString('pt-BR', {
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </p>
                </div>
              </div>
            ))}
            {loading && (
              <div className="flex justify-start">
                <div className="bg-gray-100 rounded-lg p-3">
                  <div className="flex gap-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" />
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100" />
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200" />
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="p-4 border-t">
            <div className="flex gap-2">
              <Input
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                placeholder="Digite sua mensagem..."
                disabled={loading}
              />
              <Button
                onClick={sendMessage}
                disabled={loading || !input.trim()}
                style={{ backgroundColor: branding.primary_color }}
              >
                <Send className="w-4 h-4" />
              </Button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}
```

**Arquivo:** `src/app/api/chat/message/route.ts`

```typescript
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextResponse } from 'next/server'
import { routeMessage } from '@/lib/ai/router/message-router'

export const dynamic = 'force-dynamic'

export async function POST(request: Request) {
  const body = await request.json()
  const supabase = createRouteHandlerClient({ cookies })

  const { tenantId, sessionId, message, messages } = body

  try {
    // 1. Buscar ou criar session
    let { data: session } = await supabase
      .from('conversation_sessions')
      .select('*')
      .eq('tenant_id', tenantId)
      .eq('visitor_id', sessionId)
      .single()

    if (!session) {
      const { data: newSession } = await supabase
        .from('conversation_sessions')
        .insert({
          tenant_id: tenantId,
          visitor_id: sessionId,
          messages_count: 0,
        })
        .select()
        .single()
      session = newSession
    }

    // 2. Salvar mensagem do usu√°rio
    await supabase.from('chat_messages').insert({
      tenant_id: tenantId,
      session_id: session.id,
      role: 'user',
      content: message,
    })

    // 3. Rotear para agente apropriado
    const response = await routeMessage(message, messages, tenantId)

    // 4. Salvar resposta do assistente
    await supabase.from('chat_messages').insert({
      tenant_id: tenantId,
      session_id: session.id,
      role: 'assistant',
      content: response.content,
      agent_used: response.agent,
    })

    // 5. Atualizar session
    await supabase
      .from('conversation_sessions')
      .update({
        messages_count: session.messages_count + 2,
        last_message_at: new Date().toISOString(),
        area_juridica: response.area || session.area_juridica,
      })
      .eq('id', session.id)

    // 6. Verificar se completou qualifica√ß√£o
    let qualificationData = {}
    if (response.qualificationCompleted) {
      // Criar lead
      const { data: lead } = await supabase
        .from('leads')
        .insert({
          tenant_id: tenantId,
          nome: response.leadData.name,
          email: response.leadData.email,
          telefone: response.leadData.phone,
          mensagem: response.leadData.message,
          area_juridica: response.area,
          score: response.score,
          tier: response.tier,
          origem: 'chat',
        })
        .select()
        .single()

      // Atualizar session
      await supabase
        .from('conversation_sessions')
        .update({
          qualification_completed: true,
          qualification_score: response.score,
          qualification_tier: response.tier,
          lead_created: true,
          lead_id: lead.id,
        })
        .eq('id', session.id)

      // Disparar workflow new-lead
      await fetch(`${process.env.NEXT_PUBLIC_URL}/api/workflows/triggers/new-lead`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leadId: lead.id,
          ...response.leadData,
        }),
      })

      qualificationData = {
        qualificationCompleted: true,
        score: response.score,
        tier: response.tier,
        leadId: lead.id,
      }
    }

    return NextResponse.json({
      response: response.content,
      agent: response.agent,
      ...qualificationData,
    })
  } catch (error) {
    console.error('Error processing message:', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    )
  }
}
```

**Valida√ß√£o Fase 1:**
- [ ] Chat widget renderizando no site do tenant
- [ ] Mensagens sendo salvas no banco
- [ ] Agente jur√≠dico respondendo corretamente
- [ ] Qualifica√ß√£o funcionando (103 perguntas)
- [ ] Lead sendo criado ao completar qualifica√ß√£o
- [ ] Workflow new-lead disparando

---

### FASE 2: Landing Page do Parceiro (2 dias)

**Objetivo:** Landing page linda para cada parceiro capturar leads

**Arquivo:** `src/app/[tenant]/page.tsx` (atualizar)

```typescript
import { getTenantFromHost } from '@/lib/tenant/tenant-resolver'
import { ChatWidget } from '@/components/tenant/ChatWidget'
import { headers } from 'next/headers'
import { notFound } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Check, MessageCircle, Calendar, FileText, Scale } from 'lucide-react'

export default async function TenantHomePage() {
  const headersList = headers()
  const host = headersList.get('host') || ''
  const tenant = await getTenantFromHost(host)

  if (!tenant) {
    notFound()
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
      {/* Header */}
      <header className="border-b bg-white">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            {tenant.logo_url ? (
              <img src={tenant.logo_url} alt={tenant.name} className="h-12" />
            ) : (
              <div
                className="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-xl"
                style={{ backgroundColor: tenant.primary_color }}
              >
                {tenant.name.charAt(0)}
              </div>
            )}
            <div>
              <h1 className="text-xl font-bold">{tenant.name}</h1>
              <p className="text-sm text-muted-foreground">Advocacia Especializada</p>
            </div>
          </div>
          <Button
            size="lg"
            style={{ backgroundColor: tenant.primary_color }}
            onClick={() => {
              const widget = document.querySelector('[data-chat-widget]')
              if (widget) {
                ;(widget as HTMLButtonElement).click()
              }
            }}
          >
            <MessageCircle className="mr-2 h-5 w-5" />
            Falar com Advogado
          </Button>
        </div>
      </header>

      {/* Hero */}
      <section className="container mx-auto px-4 py-20">
        <div className="max-w-3xl mx-auto text-center">
          <h2 className="text-5xl font-bold mb-6">
            Resolvemos Seu Problema Jur√≠dico
          </h2>
          <p className="text-xl text-muted-foreground mb-8">
            {tenant.welcome_message ||
             'Atendimento r√°pido e especializado. Converse agora com nosso assistente e agende uma consulta gratuita.'}
          </p>
          <Button
            size="lg"
            className="text-lg px-8 py-6"
            style={{ backgroundColor: tenant.primary_color }}
          >
            <MessageCircle className="mr-2 h-6 w-6" />
            Iniciar Conversa - √â Gr√°tis
          </Button>
        </div>
      </section>

      {/* √Åreas de Atua√ß√£o */}
      <section className="container mx-auto px-4 py-20 bg-white">
        <h3 className="text-3xl font-bold text-center mb-12">√Åreas de Atua√ß√£o</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {tenant.areas_atuacao?.map((area: string) => (
            <div key={area} className="flex items-start gap-3 p-6 border rounded-lg">
              <Scale className="h-6 w-6 flex-shrink-0" style={{ color: tenant.primary_color }} />
              <div>
                <h4 className="font-semibold mb-2 capitalize">
                  Direito {area.replace('_', ' ')}
                </h4>
                <p className="text-sm text-muted-foreground">
                  Atendimento especializado com anos de experi√™ncia
                </p>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Como Funciona */}
      <section className="container mx-auto px-4 py-20">
        <h3 className="text-3xl font-bold text-center mb-12">Como Funciona</h3>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div className="text-center">
            <div
              className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-white font-bold text-2xl"
              style={{ backgroundColor: tenant.primary_color }}
            >
              1
            </div>
            <MessageCircle className="w-8 h-8 mx-auto mb-2 text-muted-foreground" />
            <h4 className="font-semibold mb-2">Converse com IA</h4>
            <p className="text-sm text-muted-foreground">
              Nossa assistente analisa seu caso
            </p>
          </div>

          <div className="text-center">
            <div
              className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-white font-bold text-2xl"
              style={{ backgroundColor: tenant.primary_color }}
            >
              2
            </div>
            <Calendar className="w-8 h-8 mx-auto mb-2 text-muted-foreground" />
            <h4 className="font-semibold mb-2">Agende Consulta</h4>
            <p className="text-sm text-muted-foreground">
              Escolha melhor hor√°rio para voc√™
            </p>
          </div>

          <div className="text-center">
            <div
              className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-white font-bold text-2xl"
              style={{ backgroundColor: tenant.primary_color }}
            >
              3
            </div>
            <FileText className="w-8 h-8 mx-auto mb-2 text-muted-foreground" />
            <h4 className="font-semibold mb-2">Receba Proposta</h4>
            <p className="text-sm text-muted-foreground">
              Proposta clara com valores e prazos
            </p>
          </div>

          <div className="text-center">
            <div
              className="w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center text-white font-bold text-2xl"
              style={{ backgroundColor: tenant.primary_color }}
            >
              4
            </div>
            <Check className="w-8 h-8 mx-auto mb-2 text-muted-foreground" />
            <h4 className="font-semibold mb-2">Resolva seu Problema</h4>
            <p className="text-sm text-muted-foreground">
              Acompanhe tudo pelo sistema
            </p>
          </div>
        </div>
      </section>

      {/* CTA Final */}
      <section className="container mx-auto px-4 py-20">
        <div
          className="rounded-2xl p-12 text-center text-white"
          style={{ backgroundColor: tenant.primary_color }}
        >
          <h3 className="text-4xl font-bold mb-4">Pronto para Resolver?</h3>
          <p className="text-xl mb-8 opacity-90">
            Converse agora com nossa assistente. √â r√°pido, f√°cil e gratuito.
          </p>
          <Button size="lg" variant="secondary" className="text-lg px-8 py-6">
            <MessageCircle className="mr-2 h-6 w-6" />
            Iniciar Conversa Agora
          </Button>
        </div>
      </section>

      {/* Footer */}
      <footer className="border-t py-8">
        <div className="container mx-auto px-4 text-center text-sm text-muted-foreground">
          <p>¬© 2024 {tenant.name}. Todos os direitos reservados.</p>
          <p className="mt-2">
            Powered by{' '}
            <a href="https://garcezpalha.com.br" className="underline">
              Garcez Palha Engine
            </a>
          </p>
        </div>
      </footer>

      {/* Chat Widget */}
      <ChatWidget tenantId={tenant.id} />
    </div>
  )
}
```

**Valida√ß√£o Fase 2:**
- [ ] Landing page renderizando com branding do parceiro
- [ ] Chat widget integrado
- [ ] Responsivo (mobile + desktop)
- [ ] SEO tags configurados
- [ ] Performance > 90 (Lighthouse)

---

### FASE 3: Dashboard do Parceiro (3 dias)

**Objetivo:** Dashboard para advogado ver leads, m√©tricas, configurar

**Arquivo:** `src/app/(partner)/dashboard/page.tsx`

```typescript
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { MessageCircle, Users, Calendar, CheckCircle, TrendingUp } from 'lucide-react'

export const dynamic = 'force-dynamic'

export default async function PartnerDashboardPage() {
  const supabase = createServerComponentClient({ cookies })

  // Pegar tenant do usu√°rio
  const {
    data: { user },
  } = await supabase.auth.getUser()

  const { data: membership } = await supabase
    .from('tenant_members')
    .select('tenant_id')
    .eq('user_id', user?.id)
    .eq('status', 'active')
    .single()

  if (!membership) {
    return <div>Voc√™ n√£o pertence a nenhum tenant</div>
  }

  const tenantId = membership.tenant_id

  // Buscar tenant
  const { data: tenant } = await supabase
    .from('tenants')
    .select('*, plans(*)')
    .eq('id', tenantId)
    .single()

  // M√©tricas do m√™s
  const startOfMonth = new Date()
  startOfMonth.setDate(1)
  startOfMonth.setHours(0, 0, 0, 0)

  const { data: conversations } = await supabase
    .from('conversation_sessions')
    .select('*')
    .eq('tenant_id', tenantId)
    .gte('started_at', startOfMonth.toISOString())

  const { data: leads } = await supabase
    .from('leads')
    .select('*')
    .eq('tenant_id', tenantId)
    .gte('created_at', startOfMonth.toISOString())

  const { data: appointments } = await supabase
    .from('agendamentos')
    .select('*')
    .eq('tenant_id', tenantId)
    .gte('created_at', startOfMonth.toISOString())

  const { data: clients} = await supabase
    .from('clientes')
    .select('*')
    .eq('tenant_id', tenantId)
    .gte('created_at', startOfMonth.toISOString())

  // C√°lculos
  const totalConversations = conversations?.length || 0
  const qualifiedLeads = leads?.length || 0
  const scheduledAppointments = appointments?.length || 0
  const newClients = clients?.length || 0
  const conversionRate =
    qualifiedLeads > 0 ? ((newClients / qualifiedLeads) * 100).toFixed(1) : '0.0'

  // Leads HOT
  const hotLeads = leads?.filter((l) => l.tier === 'hot') || []

  return (
    <div className="container mx-auto py-8 px-4">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold">Dashboard</h1>
          <p className="text-muted-foreground">Bem-vindo, {tenant?.name}</p>
        </div>
        <div className="text-right">
          <p className="text-sm text-muted-foreground">Seu site:</p>
          <a
            href={`https://${tenant?.subdomain}`}
            target="_blank"
            rel="noopener"
            className="text-blue-600 underline"
          >
            {tenant?.subdomain}
          </a>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Conversas</CardTitle>
            <MessageCircle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{totalConversations}</div>
            <p className="text-xs text-muted-foreground">
              {tenant?.current_month_conversations || 0} / {tenant?.plans?.max_conversations_per_month === -1 ? '‚àû' : tenant?.plans?.max_conversations_per_month} este m√™s
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Leads Qualificados</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{qualifiedLeads}</div>
            <p className="text-xs text-muted-foreground">
              {hotLeads.length} HOT leads
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Consultas Agendadas</CardTitle>
            <Calendar className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{scheduledAppointments}</div>
            <p className="text-xs text-muted-foreground">Este m√™s</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Novos Clientes</CardTitle>
            <CheckCircle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{newClients}</div>
            <p className="text-xs text-muted-foreground">Este m√™s</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Taxa de Convers√£o</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{conversionRate}%</div>
            <p className="text-xs text-muted-foreground">Lead ‚Üí Cliente</p>
          </CardContent>
        </Card>
      </div>

      {/* Leads HOT */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>üî• Leads HOT - Aten√ß√£o Urgente</CardTitle>
        </CardHeader>
        <CardContent>
          {hotLeads.length === 0 ? (
            <p className="text-muted-foreground">Nenhum lead HOT no momento</p>
          ) : (
            <div className="space-y-4">
              {hotLeads.map((lead) => (
                <div
                  key={lead.id}
                  className="flex items-center justify-between p-4 border rounded-lg bg-red-50"
                >
                  <div>
                    <h4 className="font-semibold">{lead.nome}</h4>
                    <p className="text-sm text-muted-foreground">
                      {lead.area_juridica} ‚Ä¢ Score: {lead.score}/100
                    </p>
                    <p className="text-sm mt-1">{lead.mensagem?.slice(0, 100)}...</p>
                  </div>
                  <div className="text-right">
                    <p className="text-sm text-muted-foreground">
                      {new Date(lead.created_at).toLocaleDateString('pt-BR')}
                    </p>
                    <a
                      href={`/dashboard/leads/${lead.id}`}
                      className="text-sm text-blue-600 underline"
                    >
                      Ver Detalhes
                    </a>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Plano Atual */}
      <Card>
        <CardHeader>
          <CardTitle>Plano Atual</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center justify-between">
            <div>
              <h3 className="text-2xl font-bold">{tenant?.plans?.display_name}</h3>
              <p className="text-muted-foreground">
                R$ {tenant?.plans?.price_monthly}/m√™s
              </p>
            </div>
            <a href="/dashboard/assinatura" className="text-blue-600 underline">
              Gerenciar Assinatura
            </a>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

**Valida√ß√£o Fase 3:**
- [ ] Dashboard renderizando m√©tricas corretas
- [ ] Leads HOT destacados
- [ ] Link para site do parceiro funcionando
- [ ] Plano atual exibido
- [ ] Responsivo

---

## üìä CRONOGRAMA COMPLETO

| Fase | Descri√ß√£o | Dura√ß√£o |
|------|-----------|---------|
| 1 | Chat Widget Embeddable | 3 dias |
| 2 | Landing Page do Parceiro | 2 dias |
| 3 | Dashboard do Parceiro | 3 dias |
| 4 | Onboarding Flow (do white-label doc) | 3 dias |
| 5 | Multi-tenancy (do white-label doc) | 2 dias |
| 6 | Stripe Integration | 2 dias |
| **TOTAL SECRET√ÅRIA JUR√çDICA** | **15 dias** |

---

## üí∞ PRICING CORRETO

### Plano Starter - R$ 497/m√™s
**Secret√°ria Jur√≠dica IA**
- Chat IA 24/7 (9 √°reas)
- 100 conversas/m√™s
- Qualifica√ß√£o autom√°tica
- Agendamento
- Propostas
- 1 usu√°rio
- Subdom√≠nio

### Plano Pro - R$ 997/m√™s
**Secret√°ria + Marketing**
- Tudo do Starter
- 500 conversas/m√™s
- **Marketing Automation:**
  - Conte√∫do Instagram/LinkedIn
  - Otimiza√ß√£o Google Ads
  - Calend√°rio mensal
- 5 usu√°rios
- Dom√≠nio pr√≥prio
- WhatsApp + Telegram
- Suporte priorit√°rio

### Plano Enterprise - R$ 1.997/m√™s
**Solu√ß√£o Completa**
- Tudo do Pro
- Conversas ilimitadas
- Usu√°rios ilimitados
- API access
- Custom training
- Onboarding assistido
- SLA 99.9%

---

## üéØ PITCH CORRETO

### VSL Script (4min30s)

```
[0:00-0:30] GANCHO
"Dr. Silva, voc√™ sabia que est√° perdendo R$ 15.000 por m√™s?

Enquanto voc√™ dorme, 47 pessoas pesquisam 'advogado trabalhista S√£o Paulo' no Google.

12 entram no seu site.

Mas nenhuma entra em contato.

Porque seu site n√£o responde na hora.

E em 5 minutos, elas j√° ligaram para seu concorrente."

[0:30-1:30] PROBLEMA
"O problema √© simples:

Cliente quer resposta AGORA. N√£o amanh√£.

Mas voc√™ n√£o pode ficar 24h no WhatsApp.

N√£o pode contratar 3 secret√°rias para atender de madrugada.

E chatbot gen√©rico? Cliente percebe que √© rob√¥ bobo e sai.

Resultado: Voc√™ PERDE 73% dos leads do Google Ads.

Gasta R$ 3.000 em an√∫ncios, converte R$ 800.

Preju√≠zo de R$ 2.200 TODO M√äS."

[1:30-3:00] SOLU√á√ÉO
"A solu√ß√£o √© a Garcez Palha Engine.

Uma SECRET√ÅRIA JUR√çDICA com IA que:

1. Est√° no seu site 24 horas por dia, 7 dias por semana

2. Conversa com o cliente como se fosse humana
   (ela √© especializada em direito, faz as 103 perguntas certas)

3. Qualifica o caso automaticamente
   (urg√™ncia, viabilidade, valor estimado)

4. Agenda a consulta no SEU calend√°rio

5. Envia proposta personalizada com valores

E o melhor: √â 100% WHITE-LABEL.

Sua marca, seu logo, suas cores.

Cliente nem sabe que √© IA.

Pensa que √© sua secret√°ria de verdade."

[3:00-4:00] PROVA SOCIAL
"J√° temos 300 advogados usando.

Dr. Jo√£o, de Campinas:
'Em 30 dias, 47 leads qualificados. 8 viraram clientes. Faturei R$ 32.000. Pago R$ 497, lucro R$ 31.500'

Dra. Maria, de BH:
'Melhor investimento. Trabalha enquanto durmo. Acordo com 5 consultas agendadas.'

Dr. Pedro, SP:
'Cancelei chatbot de R$ 800 que n√£o funcionava. Garcez Palha por R$ 497 converte 10x mais.'"

[4:00-4:30] CTA
"Voc√™ tem 2 op√ß√µes:

Op√ß√£o 1: Continuar perdendo R$ 15.000/m√™s

Op√ß√£o 2: Testar 30 dias GR√ÅTIS

Setup em 60 segundos. Sem cart√£o de cr√©dito.

Clique no bot√£o abaixo.

Vamos configurar sua secret√°ria IA AGORA.

Em 1 minuto ela j√° est√° capturando leads.

30 dias gr√°tis. Cancela quando quiser.

Clique agora."
```

---

**FIM DO PLANO DE IMPLEMENTA√á√ÉO - SECRET√ÅRIA JUR√çDICA IA**

Este √© o produto PRINCIPAL. Marketing √© add-on no Plano Pro.

Pr√≥ximo documento: Corrigir documenta√ß√£o existente com modelo h√≠brido.
